# AI Business Research Agent - TODO

## 核心功能

- [x] 用户认证系统（Manus OAuth）
- [x] 多步骤调研创建表单
- [x] AI 人物画像生成
- [x] AI 模拟访谈对话系统
- [x] 行为分析引擎
- [x] 自动化报告生成
- [x] 调研项目管理（列表、查看、编辑、删除）
- [x] 案例研究展示页面
- [x] 定价方案页面（Free/Pro/Max）
- [ ] Stripe 支付集成

## UI/UX

- [x] 深色霓虹主题样式
- [x] 响应式导航栏
- [x] 首页 Hero 区域
- [x] 功能展示区域
- [x] 工作流程展示
- [x] 页脚组件
- [ ] 加载动画和过渡效果

## 数据库

- [x] 用户表（users）
- [x] 调研项目表（studies）
- [x] AI 人物画像表（personas）
- [x] 访谈记录表（interviews）
- [x] 访谈消息表（interview_messages）
- [x] 报告表（reports）
- [x] 订阅表（subscriptions）

## 页面路由

- [x] 首页（/）
- [x] 仪表盘（/dashboard）
- [x] 新建调研（/studies/new）
- [x] 调研详情（/studies/:id）
- [x] 访谈页面（/studies/:id/interview）
- [x] 报告页面（/studies/:id/report）
- [x] 定价页面（/pricing）
- [x] 案例展示（/case-studies）

## 新增需求

- [x] 语言切换功能（简体中文/English）
- [x] 国际化（i18n）支持
- [x] UI 风格重构为浅色调 iOS 科技风格
- [x] 更新所有页面组件应用新主题
- [x] 毛玻璃效果和圆润设计
- [x] 柔和的渐变和阴影

## 基于 Atypica.ai 的优化任务

### 交互式研究规划
- [x] 将调研创建改为多步骤交互式问答
- [x] 添加研究场景选择（工作场景/个人家庭场景）
- [x] 添加关注维度选择（需求痛点/决策逻辑/消费意愿/隐私安全）
- [x] 展示研究计划确认页面

### 思考过程展示
- [x] 添加"View Process"可折叠组件
- [ ] 在 Persona 生成时展示 AI 推理过程
- [ ] 在访谈过程中展示 JTBD 分析思路
- [ ] 在报告生成时展示关键洞察提取过程

### Persona 优化
- [ ] 增加 Persona 搜索和匹配步骤
- [ ] 展示多维度 Persona 信息（职业经历、健康状态、消费习惯）
- [ ] 支持 Premium 质量层级选择
- [ ] 添加 Persona 卡片展示组件

### 访谈交互优化
- [ ] 增加场景化提问（基于 JTBD 框架）
- [ ] 实时展示 Job Story 提取
- [ ] 支持多轮深度对话
- [ ] 添加访谈进度指示器

### 报告结构增强
- [ ] 添加 JTBD 任务拆解章节
- [ ] 增加需求痛点地图
- [ ] 添加消费决策模型分析
- [ ] 增加商业机会识别和产品设计建议
- [ ] 支持导出 PDF 报告
- [ ] 添加数据可视化图表

### Web Search 集成
- [ ] 在调研创建前进行行业背景搜索
- [ ] 展示搜索查询和结果
- [ ] 生成市场趋势总结

## AI 自动化调研功能

- [x] 设计 AI 调研智能体架构（基于 JTBD 框架）
- [x] 实现自动问题生成逻辑
- [x] 实现多轮深度访谈流程
- [x] 添加 Job Story 自动提取
- [x] 创建批量访谈后端 API
- [x] 构建自动化调研界面（左侧进度，右侧实时过程）
- [x] 实现实时流式输出
- [x] 添加访谈进度追踪
- [x] 展示思考过程和 JTBD 分析
- [x] 保存访谈记录到数据库

## Bug 修复

- [x] 修复 Persona 生成数量不匹配问题（用户选择 8 个但只生成 5 个）
- [x] 修复自动化调研启动时的 personality 数据结构错误（personality?.values?.join is not a function）

## 紧急 Bug 修复（第二轮）

- [x] 修复 personaCount 在 study 创建时未正确传递
- [x] 迁移数据库中旧格式的 persona 数据（简单数组 → 结构化对象）
- [ ] 验证新创建的 persona 数据格式正确性

## 新增功能

### Persona 预览
- [x] 在 StudyDetail 页面添加 Persona 卡片展示
- [x] 显示人物画像、性格特征、行为模式和背景故事
- [x] 添加展开/收起详情功能

### 访谈暂停恢复
- [ ] 添加暂停按钮到自动化调研界面
- [ ] 保存当前访谈进度到数据库
- [ ] 实现从上次中断处继续访谈
- [ ] 显示已完成和待完成的受访者列表

### 访谈质量评分
- [ ] 设计质量评分算法（JTBD 深度、Job Story 完整性、情感触发点识别）
- [ ] 在访谈完成后自动计算质量分数
- [ ] 在 Persona 卡片上显示质量评分
- [ ] 支持按质量排序访谈结果

## 完整国际化支持

- [ ] 扩展 LanguageContext 添加所有页面的中英文翻译
- [ ] 更新 Home 页面使用国际化文本
- [ ] 更新 Dashboard 页面使用国际化文本
- [ ] 更新 NewStudyInteractive 页面使用国际化文本
- [ ] 更新 StudyDetail 页面使用国际化文本
- [ ] 更新 AutoInterview 页面使用国际化文本
- [ ] 更新 Interview 页面使用国际化文本
- [ ] 更新 Report 页面使用国际化文本
- [ ] 更新 Pricing 页面使用国际化文本
- [ ] 更新 CaseStudies 页面使用国际化文本
- [x] 修改后端 tRPC context 传递语言偏好
- [x] 修改 LLM 调用根据语言生成对应内容（Persona 生成、访谈对话）
- [ ] 测试语言切换功能的完整性

## 国际化修复（紧急）

- [x] 修复 Home 页面未接入国际化系统
- [ ] 修复 Dashboard 页面的国际化
- [ ] 修复 NewStudyInteractive 页面的国际化
- [ ] 修复 StudyDetail 页面的国际化
- [ ] 修复 AutoInterview 页面的国际化
- [ ] 修复 Pricing 页面的国际化
- [ ] 修复 CaseStudies 页面的国际化
- [ ] 验证所有页面在中英文切换后显示正确

## 深度分析报告生成功能

### 后端 API
- [x] 创建 `report.generateDeep` API 汇总所有访谈数据
- [x] 设计六章报告结构（研究背景、人群画像、核心发现、需求障碍、核心诉求、商业机会）
- [x] 使用 LLM 生成 McKinsey 式专业报告内容
- [x] 提取关键数据用于可视化
- [x] 保存报告到数据库

### 报告设计系统
- [x] 创建专业报告组件（黑白灰+单一深蓝强调色）
- [x] 实现高度结构化排版
- [x] 设计字体层级系统
- [x] 创建用户引用卡片组件
- [x] 创建关键发现框组件

### 数据可视化
- [x] 集成 recharts 库
- [ ] 创建简洁柱状图组件
- [ ] 创建雷达图组件
- [ ] 创建优先级矩阵
- [ ] 创建决策流程图

### 报告页面
- [x] 创建深度报告展示页面
- [x] 添加“生成深度报告”按钮
- [ ] 实现报告导出 PDF 功能

### 测试
- [x] 编写深度报告生成测试
- [x] 编写报告获取测试
- [x] 运行所有测试并确保通过

## 深度报告风格调整

### 分析参考报告
- [x] 阅读参考 PDF 报告
- [x] 提取文字风格特征（语言、语气、专业术语）
- [x] 分析框架结构（章节组织、逻辑流程）
- [x] 总结视觉设计特点（排版、字体、配色、图表）

### 更新提示词
- [x] 根据参考报告调整 LLM 提示词
- [x] 优化章节结构和内容要求
- [x] 增强数据分析和洞察深度

### 调整前端组件
- [x] 更新 DeepReportView 组件结构
- [x] 调整 deep-report.css 样式
- [x] 优化排版和视觉层级

### 测试验证
- [x] 生成测试报告验证风格一致性
- [x] 确保中英文双语支持

## 设计哲学完全对齐

### 提示词优化
- [x] 更新系统提示词为"McKinsey遇见人类学田野笔记"风格
- [x] 强化信息密度要求（紧凑但不拥挤）
- [x] 优化报告标题格式为《XXXX：XX人群XX需求深度洞察》
- [x] 增加"关键启示"和"行动建议"结构要求

### 视觉组件优化
- [x] 确保极致简约的黑白灰主色调
- [x] 优化字体层级（大号粗体标题 + 中号加粗洞察 + 常规灰色正文）
- [x] 调整数据标注为小号加粗深蓝/深灰
- [x] 优化引用框为斜体+灰色+细边框

### 内容结构优化
- [x] 确保六章结构完整
- [x] 每章结尾添加"关键启示"或"行动建议"
- [x] 优化数据对比和优先级矩阵呈现
- [x] 增强决策流程图的清晰度

## 报告标题优化

### 标题生成逻辑
- [x] 更新提示词要求生成纪实文学风格标题
- [x] 标题格式：《[隐喻性主标题]-[目标人群][核心需求]深度洞察》
- [x] 提供标题示例（如"银发焦虑时代的守护者"）
- [x] 测试标题生成效果

## 报告封面设计

### 封面组件
- [x] 创建 ReportCover 组件
- [x] 设计封面布局（极简黑白灰风格）
- [x] 添加封面样式（严谨对齐、字重层级）

### 封面内容
- [x] 集成隐喻性标题
- [x] 显示调研时间
- [x] 显示受访者数量
- [x] 显示访谈次数
- [x] 添加研究机构标识

### 集成测试
- [x] 在 DeepReportView 中集成封面
- [x] 测试封面显示效果
- [x] 确保中英文双语支持

## 报告标题和机构信息修复

### 标题显示问题
- [x] 确保深度报告使用 LLM 生成的隐喻性标题
- [x] 在 DeepReportData 接口中添加 reportTitle 字段
- [x] 更新 DeepReport 页面传递 LLM 生成的标题而非原始调研标题

### 移除机构信息
- [x] 从 ReportCover 组件中移除 atypica.AI 相关内容
- [x] 从 LanguageContext 中移除机构标语翻译（保留以便兼容）
- [x] 更新封面样式移除底部机构区域

### Gemini 3 Pro 集成
- [x] 研究 Gemini 3 Pro 模型调用方式
- [x] 更新 LLM 调用代码支持模型选择
- [x] 测试 Gemini 3 Pro 生成效果

## 报告标题显示和格式修复

### 修复标题显示错误
- [x] 检查 DeepReportView 组件，确保使用 reportTitle 而不是 chapter1.title
- [x] 检查封面组件，确保使用正确的标题字段
- [x] 验证 fallback 逻辑正确性

### 更新标题为两行格式
- [x] 更新 JSON schema 支持两行标题结构（mainTitle + subtitle）
- [x] 更新提示词要求生成两行分离的标题
- [x] 更新 DeepReportData 接口支持两行标题
- [x] 更新封面和报告头部显示两行标题
- [x] 优化两行标题的视觉层级（第一行大号粗体，第二行中号常规）

### 测试验证
- [x] 测试标题显示正确性
- [x] 测试两行标题格式
- [x] 确保中英文双语支持

## 清理旧报告数据

### 数据清理
- [x] 创建 deep_reports 表存储完整 JSON 数据
- [x] 更新 generateDeep 保存到 deep_reports 表
- [x] 更新 getDeepReport 从 deep_reports 表读取
- [x] 生成新报告时自动删除旧报告

## 报告引用来源功能

### 提示词更新
- [x] 更新系统提示词要求 LLM 为每个观点、数据、论据标注来源
- [x] 要求引用格式：[编号] 受访者姓名，年龄，职业 —— "引用语句"（访谈时间）
- [x] 要求文中使用 [1][2][3] 引用编号标注

### Schema 更新
- [x] 在 JSON schema 顶层添加 sources 数组字段
- [x] sources 字段包含：id（引用编号）、intervieweeName、age、occupation、quote、interviewDate
- [x] 更新 DeepReportData 接口支持 sources 字段

### 前端组件
- [x] 在 DeepReportView 组件中添加引用来源区域
- [x] 在报告底部添加引用来源列表
- [x] 实现引用编号显示
- [x] 添加引用来源样式（灰色背景 + 深蓝左边框 + 斜体引用）

### 国际化
- [x] 在 LanguageContext 中添加引用来源翻译
- [x] 中英文双语支持

### 测试
- [x] 所有单元测试通过（11个测试）

## 修正引用来源功能（紧急）

### 问题分析
- [x] 当前实现：在报告末尾单独列出引用来源列表
- [x] 参考报告：引用直接嵌入正文中，格式为 “引用内容” —— 受访者姓名，年龄，职业

### 修正方案
- [x] 更新提示词：要求 LLM 在生成内容时直接在每个观点、数据、论据后紧跟引用
- [x] 移除 sources 数组字段从 JSON schema
- [x] 移除前端 DeepReportView 组件中的引用来源区域
- [x] 移除 deep-report.css 中的引用来源样式
- [x] 更新 DeepReportData 接口移除 sources 字段

### 测试验证
- [x] 运行单元测试确保无错误（11个测试全部通过）
- [x] TypeScript 类型检查通过
- [x] 保存 checkpoint

## PDF 导出和分享功能

### 需求分析
- [x] 用户点击“导出 PDF”按钮后，生成包含完整报告内容的 PDF 文件
- [x] PDF 需要保留报告的专业排版和样式
- [x] 支持中英文双语 PDF 导出

### 实现方案
- [x] 使用浏览器 window.print() API，无需后端处理
- [x] 添加 @media print CSS 样式
- [x] 隐藏导航栏、页脚、按钮等非报告元素
- [x] 设置 A4 页面尺寸和边距
- [x] 防止关键元素分页断裂

### 前端实现
- [x] 在 DeepReport 页面添加 onClick 事件
- [x] 为 Header Actions 添加 CSS 类
- [x] 添加打印样式到 deep-report.css

### 测试
- [x] 所有单元测试通过（11个测试）
- [x] TypeScript 类型检查通过

## 行业背景分析引用来源功能

### 需求分析
- [x] 在创建调研项目第2步（研究背景页面）的“行业背景分析”区域
- [x] 显示 AI 生成的行业分析内容的引用来源
- [x] 引用来源包括：来源名称、发布年份
- [x] 在每个分析发现下方显示引用来源

### 后端实现
- [x] 创建 study.analyzeIndustry API
- [x] 使用 LLM 生成 3-5 个关键发现
- [x] 在 JSON schema 中添加 findings 数组，每个包含 text, source, year
- [x] 返回结构化数据

### 前端实现
- [x] 更新 NewStudyInteractive.tsx 组件
- [x] 将模拟搜索改为真实 API 调用
- [x] 在每个发现下方显示引用来源（灰色小字）
- [x] 格式：—— 来源名称，年份

### 测试
- [x] 所有单元测试通过（11个测试）
- [x] TypeScript 类型检查通过

## 研究场景 AI 描述功能

### 需求分析
- [x] 在第3步“研究场景”页面，根据用户填写的调研目标和人群画像
- [x] 使用 AI 生成有针对性的场景描述，替换固定的通用文案
- [x] 为三个选项（工作场景、个人/家庭场景、两个场景都关注）生成定制化描述

### 后端实现
- [x] 创建 study.generateScenarioDescriptions API
- [x] 接收 targetAudience 和 researchGoal
- [x] 使用 LLM 生成三个场景的定制化描述（15-25字）
- [x] 返回格式：{ work: "描述", personal: "描述", both: "描述" }

### 前端实现
- [x] 更新 NewStudyInteractive.tsx 组件
- [x] 在进入第3步时自动调用 API 生成场景描述
- [x] 将生成的描述应用到三个单选按钮
- [x] 显示加载状态（“正在生成针对您目标人群的场景描述...”）
- [x] 失败后使用默认描述作为退路

### 测试
- [x] 创建单元测试验证 API 功能
- [x] 所有测试通过（13个测试）
- [x] 验证生成的场景描述符合要求（简洁、有针对性）

## 研究维度 AI 推荐功能

### 需求分析
- [x] 在第4步“研究维度”页面，基于 AI 分析推荐相关调研维度
- [x] 根据用户填写的目标人群、调研目标和选择的场景
- [x] 推荐 5-8 个最相关的调研维度
- [x] 为每个维度生成简洁的说明文字

### 后端实现
- [x] 创建 study.recommendDimensions API
- [x] 接收 targetAudience, researchGoal, scenario
- [x] 使用 LLM 分析并推荐调研维度
- [x] 返回格式：[{ name: "维度名称" (8-12字), description: "维度说明" (20-30字) }]

### 前端实现
- [x] 更新 NewStudyInteractive.tsx 组件
- [x] 在进入第4步时自动调用 API 推荐维度
- [x] 显示推荐的维度列表（可多选）
- [x] 显示加载状态（“正在基于您的调研目标推荐相关维度...”）
- [x] 失败后使用默认维度作为退路

### 测试
- [x] 创建单元测试验证 API 功能
- [x] 所有测试通过（14个测试）
- [x] 验证推荐的维度数量和质量（5-8个，有针对性）

## 调研计划 AI 推荐功能

### 需求分析
- [x] 在第5步“研究计划确认”页面，基于 AI 分析推荐最佳调研计划
- [x] 根据用户选择的调研维度、目标人群和研究场景
- [x] 推荐最佳访谈数量（建议范围）
- [x] 推荐每次访谈时长（分钟）
- [x] 推荐问题类型（开放式/半结构化/结构化）
- [x] 提供推荐理由说明

### 后端实现
- [x] 创建 study.recommendResearchPlan API
- [x] 接收 targetAudience, researchGoal, scenario, dimensions
- [x] 使用 LLM 分析并推荐调研计划
- [x] 返回格式：{ interviewCount: { min: number, max: number }, duration: number, questionType: string, rationale: string }

### 前端实现
- [x] 更新 NewStudyInteractive.tsx 组件
- [x] 在进入第5步时自动调用 API 推荐调研计划
- [x] 显示推荐的访谈数量、时长和问题类型
- [x] 显示推荐理由（突出显示在蓝色边框区域）
- [x] 显示加载状态（“正在基于您的调研维度推荐最佳调研计划...”）
- [x] 失败后使用默认计划作为退路

### 测试
- [x] 创建单元测试验证 API 功能
- [x] 所有测试通过（15个测试）
- [x] 验证推荐的合理性：访谈数量 15-25次，时长 60分钟，问题类型半结构化

## 修复创建调研项目错误（紧急）

### 问题描述
- [x] 在第5步点击“开始执行研究”时报错
- [x] 错误信息：researchQuestions 字段期望 string[]，但接收到 undefined
- [x] 原因：旧代码使用固定的 labels 映射，但 AI 推荐的维度是自定义名称

### 修复方案
- [x] 查找 NewStudyInteractive.tsx 中的 handleCreateStudy 函数
- [x] 直接使用 plan.dimensions 作为 researchQuestions
- [x] 添加默认值防止维度为空

### 测试
- [x] 所有测试通过（15个测试）
- [x] 修复后用户可以成功创建项目

## 访谈记录列表功能

### 需求分析
- [x] 在 dashboard 报告模块中将“基础报告”改名为“访谈记录”
- [x] 点击“访谈记录”后显示本次调研所有已完成的 AI personas 访谈记录列表
- [x] 每条记录显示 persona 基本信息（姓名、年龄、职业、地点）
- [x] 点击记录可查看完整的访谈对话内容

### 后端实现
- [x] 使用现有的 interview.getByStudyId API
- [x] API 返回完整的访谈对话数据

### 前端实现
- [x] 在 StudyDetail.tsx 中修改“基础报告”为“访谈记录”
- [x] 修改路由从 /studies/:id/report 到 /studies/:id/interviews
- [x] 创建 InterviewList.tsx 组件
- [x] 实现访谈记录列表显示（卡片式布局）
- [x] 实现访谈详情弹窗查看功能
- [x] 显示对话数量和创建日期

### 测试
- [x] 页面组件创建完成，服务器启动正常
- [x] 路由配置正确
